<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TON Wallet Token Extractor</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial;
      text-align: center;
      padding: 2rem;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #fff);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #log {
      margin-top: 20px;
      text-align: left;
      padding: 10px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      border-radius: 8px;
      word-wrap: break-word;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>TON Wallet Token Extractor</h2>
  <button id="connectWallet">Connect Telegram Wallet</button>
  <button id="getToken" disabled>Show Captured Token</button>
  <pre id="log">Ready...</pre>

  <script>
    const log = document.getElementById('log');
    const connectBtn = document.getElementById('connectWallet');
    const getTokenBtn = document.getElementById('getToken');
    const tg = window.Telegram.WebApp;

    tg.ready();
    tg.expand();

    let capturedTokens = [];
    let walletAddress = null;

    function appendLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
      log.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    // Intercept ALL network traffic
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const [url, options] = args;
      
      appendLog(`ğŸ“¡ ${url}`);
      
      if (options?.headers) {
        const headers = options.headers instanceof Headers ? 
          Object.fromEntries(options.headers.entries()) : options.headers;
        
        if (headers['Authorization'] || headers['authorization']) {
          const authHeader = headers['Authorization'] || headers['authorization'];
          if (authHeader.startsWith('Bearer ')) {
            const token = authHeader.replace('Bearer ', '');
            capturedTokens.push(token);
            appendLog('ğŸ¯ BEARER TOKEN CAPTURED!', 'success');
            getTokenBtn.disabled = false;
          }
        }
      }
      
      return originalFetch.apply(this, args);
    };

    // Intercept XHR
    const originalXHRSetHeader = XMLHttpRequest.prototype.setRequestHeader;
    XMLHttpRequest.prototype.setRequestHeader = function(header, value) {
      if (header.toLowerCase() === 'authorization' && value.startsWith('Bearer ')) {
        const token = value.replace('Bearer ', '');
        capturedTokens.push(token);
        appendLog('ğŸ¯ BEARER TOKEN CAPTURED!', 'success');
        getTokenBtn.disabled = false;
      }
      return originalXHRSetHeader.apply(this, arguments);
    };

    appendLog('âœ“ Network interception active', 'success');

    // Connect to Telegram Wallet using the proper API
    connectBtn.onclick = async () => {
      try {
        appendLog('Requesting Telegram Wallet access...');
        
        // Use the Telegram WebApp method to request wallet
        if (tg.requestWriteAccess) {
          tg.requestWriteAccess(async (granted) => {
            if (granted) {
              appendLog('âœ“ Write access granted', 'success');
              
              // Now trigger actual wallet connection
              // This uses Telegram's internal wallet API
              try {
                appendLog('Opening Telegram Wallet...');
                
                // This should trigger the wallet and its API calls
                const result = await tg.openLink('https://t.me/wallet?startapp=connect', {
                  try_instant_view: true
                });
                
                appendLog('Wallet connection initiated...');
                appendLog('Waiting for API calls...');
                
                // Alternative: Use invoice method which definitely hits wallet API
                setTimeout(() => {
                  appendLog('\nTrying invoice method...');
                  if (tg.openInvoice) {
                    // This will definitely make authenticated wallet API calls
                    tg.openInvoice('test_invoice', (status) => {
                      appendLog(`Invoice status: ${status}`);
                    });
                  }
                }, 2000);
                
              } catch (e) {
                appendLog(`Wallet open error: ${e.message}`, 'error');
              }
            } else {
              appendLog('Write access denied', 'error');
              tg.showAlert('Please grant write access to continue');
            }
          });
        } else {
          appendLog('requestWriteAccess not available', 'error');
          
          // Fallback: directly open wallet
          appendLog('Using fallback method...');
          tg.openTelegramLink('https://t.me/wallet');
          appendLog('Wallet opened externally');
          appendLog('Please perform any wallet action and return here');
        }

      } catch (e) {
        appendLog(`Error: ${e.message}`, 'error');
      }
    };

    // Display captured token
    getTokenBtn.onclick = async () => {
      try {
        if (capturedTokens.length === 0) {
          appendLog('âš ï¸ No tokens captured yet!', 'error');
          return;
        }

        const token = capturedTokens[capturedTokens.length - 1];
        
        appendLog('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
        appendLog('âœ“ WALLET API BEARER TOKEN!', 'success');
        appendLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n', 'success');
        appendLog(token);
        
        // Try JWT decode
        try {
          const parts = token.split('.');
          if (parts.length === 3) {
            const payload = JSON.parse(atob(parts[1]));
            appendLog('\nJWT Payload:');
            appendLog(JSON.stringify(payload, null, 2));
          }
        } catch (e) {}

        await navigator.clipboard.writeText(token);
        tg.showAlert('âœ“ Token copied to clipboard!');
        appendLog('\nâœ“ Copied to clipboard!', 'success');

      } catch (e) {
        appendLog(`Error: ${e.message}`, 'error');
      }
    };
    
  </script>
</body>
</html>