<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TON Wallet Connect</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial;
      text-align: center;
      padding: 2rem;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #fff);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #log {
      margin-top: 20px;
      text-align: left;
      padding: 10px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      border-radius: 8px;
      word-wrap: break-word;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>TON Wallet API Token Extractor</h2>
  <button id="openWallet">Open Telegram Wallet</button>
  <button id="getToken" disabled>Extract Bearer Token</button>
  <pre id="log">Ready to connect...</pre>

  <script>
    const log = document.getElementById('log');
    const openWalletBtn = document.getElementById('openWallet');
    const getTokenBtn = document.getElementById('getToken');
    const tg = window.Telegram.WebApp;

    tg.ready();
    tg.expand();

    let capturedTokens = [];
    let allRequests = [];

    function appendLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
      log.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    // Intercept ALL network traffic
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const [url, options] = args;
      
      appendLog(`📡 Fetch: ${url}`);
      
      if (options?.headers) {
        const headers = options.headers instanceof Headers ? 
          Object.fromEntries(options.headers.entries()) : options.headers;
        
        // Log all headers
        Object.keys(headers).forEach(key => {
          appendLog(`  ${key}: ${headers[key].substring(0, 50)}...`);
        });
        
        if (headers['Authorization'] || headers['authorization']) {
          const authHeader = headers['Authorization'] || headers['authorization'];
          if (authHeader.startsWith('Bearer ')) {
            const token = authHeader.replace('Bearer ', '');
            capturedTokens.push(token);
            appendLog('🎯 BEARER TOKEN CAPTURED!', 'success');
            getTokenBtn.disabled = false;
          }
        }
      }
      
      allRequests.push({ url, options });
      return originalFetch.apply(this, args);
    };

    // Intercept XMLHttpRequest
    const originalXHROpen = XMLHttpRequest.prototype.open;
    const originalXHRSetHeader = XMLHttpRequest.prototype.setRequestHeader;
    
    XMLHttpRequest.prototype.open = function(method, url) {
      this._url = url;
      appendLog(`📡 XHR: ${method} ${url}`);
      return originalXHROpen.apply(this, arguments);
    };
    
    XMLHttpRequest.prototype.setRequestHeader = function(header, value) {
      appendLog(`  ${header}: ${value.substring(0, 50)}...`);
      
      if (header.toLowerCase() === 'authorization' && value.startsWith('Bearer ')) {
        const token = value.replace('Bearer ', '');
        capturedTokens.push(token);
        appendLog('🎯 BEARER TOKEN CAPTURED (XHR)!', 'success');
        getTokenBtn.disabled = false;
      }
      return originalXHRSetHeader.apply(this, arguments);
    };

    appendLog('✓ Network interception active', 'success');
    appendLog('All requests will be logged...\n');

    // Open Telegram Wallet directly
    openWalletBtn.onclick = async () => {
      try {
        appendLog('Opening Telegram Wallet...');
        
        // Method 1: Use openInvoice to trigger wallet
        if (tg.openInvoice) {
          // This will open the payment/wallet interface
          tg.showPopup({
            title: 'Open Wallet',
            message: 'This will open your Telegram Wallet. All network requests will be captured.',
            buttons: [
              {id: 'open', type: 'default', text: 'Open Wallet'},
              {id: 'cancel', type: 'cancel'}
            ]
          }, (buttonId) => {
            if (buttonId === 'open') {
              // Try to open wallet via bot command
              tg.sendData('open_wallet');
              appendLog('Wallet open command sent');
              appendLog('Please interact with your wallet...');
            }
          });
        }
        
        // Method 2: Request contact/location (triggers API calls)
        appendLog('\nAlternative: Requesting user data...');
        tg.requestContact((success, data) => {
          if (success) {
            appendLog('✓ Contact shared', 'success');
          }
        });
        
        // Method 3: Try to access Telegram Wallet via deep link
        const walletBotLink = 'https://t.me/wallet';
        appendLog(`\n📱 Opening: ${walletBotLink}`);
        appendLog('After opening wallet, perform any action (send, receive, etc.)');
        appendLog('Return here and check captured tokens\n');
        
        tg.openLink(walletBotLink);

      } catch (e) {
        appendLog(`Error: ${e.message}`, 'error');
      }
    };

    // Extract and display captured tokens
    getTokenBtn.onclick = async () => {
      try {
        if (capturedTokens.length === 0) {
          appendLog('⚠️ No Bearer tokens captured yet!', 'error');
          appendLog('\nTips:', 'error');
          appendLog('1. Open Telegram Wallet (@wallet)');
          appendLog('2. Perform any action (check balance, send TON, etc.)');
          appendLog('3. Return to this app');
          appendLog('4. Click this button again');
          return;
        }

        appendLog('\n═══════════════════════════════', 'success');
        appendLog(`✓ ${capturedTokens.length} BEARER TOKEN(S) CAPTURED!`, 'success');
        appendLog('═══════════════════════════════\n', 'success');
        
        capturedTokens.forEach((token, index) => {
          appendLog(`\nToken #${index + 1}:`);
          appendLog(token);
          
          // Try to decode if JWT
          try {
            const parts = token.split('.');
            if (parts.length === 3) {
              const payload = JSON.parse(atob(parts[1]));
              appendLog('\nJWT Payload:');
              appendLog(JSON.stringify(payload, null, 2));
            }
          } catch (e) {
            appendLog('(Non-JWT token)');
          }
        });

        // Copy latest token
        const latestToken = capturedTokens[capturedTokens.length - 1];
        await navigator.clipboard.writeText(latestToken);
        tg.showAlert(`✓ Latest token copied!\n\nTotal tokens captured: ${capturedTokens.length}`);
        appendLog('\n✓ Latest token copied to clipboard!', 'success');
        
        appendLog('\n📝 All captured requests:');
        allRequests.forEach((req, i) => {
          appendLog(`${i + 1}. ${req.url}`);
        });

      } catch (e) {
        appendLog(`Error: ${e.message}`, 'error');
      }
    };

    appendLog('Instructions:');
    appendLog('1. Click "Open Telegram Wallet"');
    appendLog('2. Perform any wallet action');
    appendLog('3. Return here and click "Extract Bearer Token"\n');
    
  </script>
</body>
</html>