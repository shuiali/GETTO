<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TON Wallet Connect</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
  <style>
    body {
      font-family: Arial;
      text-align: center;
      padding: 2rem;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #fff);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #log {
      margin-top: 20px;
      text-align: left;
      padding: 10px;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      border-radius: 8px;
      word-wrap: break-word;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>TON Wallet API Token Extractor</h2>
  <button id="connectWallet">Connect Wallet</button>
  <button id="getToken" disabled>Extract Bearer Token</button>
  <button id="interceptNetwork">Intercept Network</button>
  <pre id="log">Ready to connect...</pre>

  <script>
    const log = document.getElementById('log');
    const connectBtn = document.getElementById('connectWallet');
    const getTokenBtn = document.getElementById('getToken');
    const interceptBtn = document.getElementById('interceptNetwork');
    const tg = window.Telegram.WebApp;

    tg.ready();
    tg.expand();

    let walletConnection = null;
    let bearerToken = null;
    let walletAddress = null;

    function appendLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
      log.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
    }

    // Intercept fetch to capture Bearer token
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const [url, options] = args;
      
      // Log all requests
      if (options?.headers) {
        const headers = options.headers instanceof Headers ? 
          Object.fromEntries(options.headers.entries()) : options.headers;
        
        if (headers['Authorization'] || headers['authorization']) {
          const authHeader = headers['Authorization'] || headers['authorization'];
          if (authHeader.startsWith('Bearer ')) {
            bearerToken = authHeader.replace('Bearer ', '');
            appendLog('🎯 BEARER TOKEN INTERCEPTED!', 'success');
            appendLog(`Token: ${bearerToken.substring(0, 50)}...`);
            getTokenBtn.disabled = false;
          }
        }
      }
      
      return originalFetch.apply(this, args);
    };

    // Intercept XMLHttpRequest too
    const originalOpen = XMLHttpRequest.prototype.open;
    const originalSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
    
    XMLHttpRequest.prototype.setRequestHeader = function(header, value) {
      if (header.toLowerCase() === 'authorization' && value.startsWith('Bearer ')) {
        bearerToken = value.replace('Bearer ', '');
        appendLog('🎯 BEARER TOKEN INTERCEPTED (XHR)!', 'success');
        appendLog(`Token: ${bearerToken.substring(0, 50)}...`);
        getTokenBtn.disabled = false;
      }
      return originalSetRequestHeader.apply(this, arguments);
    };

    interceptBtn.onclick = () => {
      appendLog('✓ Network interception active', 'success');
      appendLog('Waiting for API calls...');
      interceptBtn.disabled = true;
    };

    // Connect wallet using Telegram Wallet
    connectBtn.onclick = async () => {
      try {
        appendLog('Connecting to Telegram Wallet...');
        
        // Use Telegram's internal wallet connection
        if (tg.openTelegramLink) {
          // Try to trigger wallet connection
          const walletUrl = 'ton://transfer/YOUR_ADDRESS';
          tg.openLink(walletUrl);
          appendLog('Wallet connection requested...');
        }

        // Alternative: Use TON Connect SDK
        if (typeof TonConnectSDK !== 'undefined') {
          const connector = new TonConnectSDK.TonConnect({
            manifestUrl: 'https://yourdomain.com/tonconnect-manifest.json'
          });
          
          const walletsList = await connector.getWallets();
          appendLog(`Found ${walletsList.length} wallets`);
          
          // Connect to Telegram Wallet
          const telegramWallet = walletsList.find(w => w.name === 'Telegram Wallet');
          if (telegramWallet) {
            await connector.connect(telegramWallet);
            appendLog('✓ Wallet connected!', 'success');
            walletConnection = connector;
            getTokenBtn.disabled = false;
          }
        }

        // Fallback: Request write access which triggers wallet APIs
        tg.requestWriteAccess((granted) => {
          if (granted) {
            appendLog('✓ Write access granted!', 'success');
            appendLog('Making authenticated request...');
            
            // Trigger an API call that uses Bearer token
            makeAuthenticatedRequest();
          }
        });

      } catch (e) {
        appendLog(`Error: ${e.message}`, 'error');
        tg.showAlert('Error: ' + e.message);
      }
    };

    // Make a request that will use Bearer token
    async function makeAuthenticatedRequest() {
      try {
        // Try to access wallet data which requires Bearer token
        const response = await fetch('https://wallet.telegram.org/api/v1/user/info', {
          headers: {
            'Authorization': `Bearer ${tg.initData}` // This will be intercepted
          }
        });
        
        appendLog('API request sent, check for intercepted token...');
      } catch (e) {
        appendLog('Request made (may fail, but token intercepted)');
      }
    }

    // Extract and display the Bearer token
    getTokenBtn.onclick = async () => {
      try {
        if (!bearerToken) {
          appendLog('⚠️ No Bearer token captured yet!', 'error');
          appendLog('Try connecting wallet or making a transaction');
          return;
        }

        appendLog('\n═══════════════════════════════', 'success');
        appendLog('✓ WALLET API BEARER TOKEN EXTRACTED!', 'success');
        appendLog('═══════════════════════════════\n', 'success');
        
        appendLog(`\nBearer Token:\n${bearerToken}\n`);
        
        // Try to decode if it's a JWT
        try {
          const parts = bearerToken.split('.');
          if (parts.length === 3) {
            const payload = JSON.parse(atob(parts[1]));
            appendLog('Token Payload:');
            appendLog(JSON.stringify(payload, null, 2));
          }
        } catch (e) {
          appendLog('Token format: Non-JWT bearer token');
        }

        // Copy to clipboard
        await navigator.clipboard.writeText(bearerToken);
        tg.showAlert('✓ Bearer Token copied to clipboard!');
        appendLog('\n✓ Token copied to clipboard!', 'success');
        
        appendLog('\n📝 Usage:');
        appendLog('Authorization: Bearer ' + bearerToken.substring(0, 30) + '...');

      } catch (e) {
        appendLog(`Error: ${e.message}`, 'error');
      }
    };

    appendLog('Ready! Click "Intercept Network" then "Connect Wallet"');
    
  </script>
</body>
</html>